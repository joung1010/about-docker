## Docker로 MySQL 실행시켜보기

### 1. MySQL 이미지를 바탕으로 컨테이너 실행시키기

```bash
$ docker run -e MYSQL_ROOT_PASSWORD=password123 -p 3306:3306 -d mysql
```

### **명령어 상세 분석**

```
docker run 옵션 분석:
-e MYSQL_ROOT_PASSWORD=password123: 환경 변수 설정
-p 3306:3306: 포트 매핑 (호스트:컨테이너)
-d: 백그라운드 실행
mysql: 이미지명 (mysql:latest와 동일)
```

**참고)** `docker pull` 과정은 생략해도 상관없어요. 왜냐하면 `docker run mysql`로 실행시켰을 때, 로컬에 이미지가 없으면 Docker Hub으로부터 MySQL 이미지를 알아서 다운받아서 실행시키기 때문이에요.

### **환경 변수 설정**

- **`e MYSQL_ROOT_PASSWORD=password123`** : `e` 옵션은 컨테이너의 환경 변수를 설정하는 옵션이에요.

Docker Hub의 MySQL 공식 문서를 보면 환경 변수로 `MYSQL_ROOT_PASSWORD`를 정해주어야만 정상적으로 컨테이너가 실행된다고 적혀있어요.

```bash
MySQL 환경 변수들:
MYSQL_ROOT_PASSWORD: root 사용자 비밀번호 (필수)
MYSQL_DATABASE: 초기 생성할 데이터베이스명
MYSQL_USER: 추가 사용자명
MYSQL_PASSWORD: 추가 사용자 비밀번호
MYSQL_ALLOW_EMPTY_PASSWORD: 빈 비밀번호 허용 (보안상 비권장)
MYSQL_RANDOM_ROOT_PASSWORD: 랜덤 root 비밀번호 생성

복합 설정 예시:
$ docker run -d \
  -e MYSQL_ROOT_PASSWORD=rootpass123 \
  -e MYSQL_DATABASE=myapp \
  -e MYSQL_USER=appuser \
  -e MYSQL_PASSWORD=userpass123 \
  -p 3306:3306 \
  --name mysql-server \
  mysql:8.0
```

### **환경 변수 확인하기**

아래의 명령어로 컨테이너로 들어가서 환경 변수를 직접 눈으로 확인해보죠.

```bash
$ docker exec -it [MySQL 컨테이너 ID] bash

$ echo $MYSQL_ROOT_PASSWORD *# MYSQL_ROOT_PASSWORD라는 환경변수 값 출력*
$ export *# 설정되어 있는 모든 환경변수 출력*
```

### **실제 환경 변수 확인 과정**

```bash
컨테이너 실행:
$ docker run -e MYSQL_ROOT_PASSWORD=password123 -p 3306:3306 -d --name mysql-test mysql
abc123def456

컨테이너 접속:
$ docker exec -it mysql-test bash
root@abc123def456:/*#* 

환경 변수 확인:
root@abc123def456:/*# echo $MYSQL_ROOT_PASSWORD*
password123

root@abc123def456:/*# env | grep MYSQL*
MYSQL_ROOT_PASSWORD=password123
MYSQL_MAJOR=8.0
MYSQL_VERSION=8.0.35-1debian12

모든 환경 변수 출력:
root@abc123def456:/*# export*
declare -x HOME="/root"
declare -x HOSTNAME="abc123def456"
declare -x MYSQL_ROOT_PASSWORD="password123"
declare -x PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
declare -x PWD="/"
declare -x TERM="xterm"
```

### 2. 컨테이너가 잘 실행되고 있는지 체크

```bash
$ docker ps
```

### **MySQL 컨테이너 상태 확인**

```bash
출력 예시:
CONTAINER ID   IMAGE   COMMAND                  CREATED         STATUS         PORTS                    NAMES
abc123def456   mysql   "docker-entrypoint.s…"   2 minutes ago   Up 2 minutes   0.0.0.0:3306->3306/tcp   mysql-test

상태 확인 포인트:
- STATUS: "Up 2 minutes" (정상 실행 중)
- PORTS: "0.0.0.0:3306->3306/tcp" (포트 매핑 정상)
- COMMAND: "docker-entrypoint.s..." (MySQL 시작 스크립트 실행)

추가 상태 확인:
$ docker stats mysql-test
CONTAINER ID   NAME        CPU %     MEM USAGE / LIMIT     MEM %     NET I/O       BLOCK I/O   PIDS
abc123def456   mysql-test  0.15%     373.2MiB / 7.765GiB   4.70%     656B / 0B     0B / 0B     37
```

### 3. 컨테이너 실행시킬 때 에러 없이 잘 실행됐는지 로그 체크

```bash
$ docker logs [컨테이너 ID 또는 컨테이너명]
```

### **MySQL 초기화 로그 분석**

```bash
MySQL 정상 시작 로그:
$ docker logs mysql-test

2023-11-15 10:30:45+00:00 [Note] [Entrypoint]: Entrypoint script for MySQL Server 8.0.35-1debian12 started.
2023-11-15 10:30:45+00:00 [Note] [Entrypoint]: Switching to dedicated user 'mysql'
2023-11-15 10:30:45+00:00 [Note] [Entrypoint]: Entrypoint script for MySQL Server 8.0.35-1debian12 started.
2023-11-15 10:30:45+00:00 [Note] [Entrypoint]: Initializing database files
...
2023-11-15T10:30:50.123456Z 0 [System] [MY-013169] [Server] /usr/sbin/mysqld (mysqld 8.0.35) initializing of server in progress as process 80
2023-11-15T10:30:52.456789Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started.
2023-11-15T10:30:55.789012Z 1 [System] [MY-013577] [InnoDB] InnoDB initialization has ended.
...
2023-11-15T10:30:58.123456Z 0 [Warning] [MY-000081] [Server] option 'default_authentication_plugin' is deprecated and will be removed in a future release. Please use authentication_policy instead.
2023-11-15T10:30:58.234567Z 0 [System] [MY-010931] [Server] /usr/sbin/mysqld: ready for connections. Version: '8.0.35'  socket: '/var/run/mysqld/mysqld.sock'  port: 3306

핵심 메시지:
"ready for connections" - MySQL 서버가 연결 대기 상태
"port: 3306" - 3306 포트에서 서비스 중
```

### **일반적인 에러와 해결 방법**

```bash
환경 변수 누락 에러:
error: database is uninitialized and password option is not specified
해결: MYSQL_ROOT_PASSWORD 환경 변수 설정 필요

포트 충돌 에러:
Error starting userland proxy: listen tcp4 0.0.0.0:3306: bind: address already in use
해결: 다른 포트 사용 (-p 3307:3306)

메모리 부족 에러:
mysqld: [ERROR] Fatal error: Out of memory
해결: 메모리 제한 늘리기 (docker run -m 2g)

데이터 디렉토리 권한 에러:
[ERROR] --initialize specified but the data directory has files in it
해결: 볼륨 디렉토리 정리 또는 새 볼륨 사용
```

### 4.GUIL 툴로 연결시켜보기

### **DBeaver 연결 설정**

```
DBeaver 연결 정보:
- Server Host: localhost (또는 127.0.0.1)
- Port: 3306
- Database: (비워두거나 mysql)
- Username: root
- Password: password123

연결 테스트:
1. DBeaver 실행
2. 새 연결 생성 (Database > New Database Connection)
3. MySQL 선택
4. 연결 정보 입력
5. "Test Connection" 클릭
6. "Connected" 메시지 확인
```

### **명령줄 클라이언트 연결**

```bash
호스트에서 MySQL 클라이언트로 연결:
$ mysql -h localhost -P 3306 -u root -p
Enter password: password123

mysql> SHOW DATABASES;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+

컨테이너 내부에서 연결:
$ docker exec -it mysql-test mysql -u root -p
Enter password: password123

mysql> SELECT VERSION();
+-----------+
| VERSION() |
+-----------+
| 8.0.35    |
+-----------+
```
  
  
---

## 볼륨(Volume)을 활용해 MySQL 컨테이너 띄우기

### 1. MySQL 컨테이너 띄우기

```bash
$ cd /Users/jaeseong/Documents/Develop
$ mkdir docker-mysql # MySQL 데이터를 저장하고 싶은 폴더 만들기# docker run -e MYSQL_ROOT_PASSWORD=password123 -p 3306:3306 -v {호스트의 절대경로}/mysql_data:/var/lib/mysql -d mysql
$ docker run -e MYSQL_ROOT_PASSWORD=password123 -p 3306:3306 -v /Users/jaeseong/Documents/Develop/docker-mysql/mysql_data:/var/lib/mysql -d mysql
```

### **경로 확인과 설정**

`pwd` 명령어로 볼륨으로 사용하고자 하는 경로를 확인한 뒤 입력해주세요.

```bash
현재 위치 확인:
$ pwd
/Users/jaeseong/Documents/Develop

절대 경로 구성:
macOS/Linux: /Users/jaeseong/Documents/Develop/docker-mysql/mysql_data
Windows: C:/Users/jaeseong/Documents/Develop/docker-mysql/mysql_data

윈도우 예시:
$ docker run -e MYSQL_ROOT_PASSWORD=password123 -p 3306:3306 -v C:/Users/jaeseong/js-mysql:/var/lib/mysql -d mysql
```

### **중요한 주의사항**

**주의)** `mysql_data` 디렉토리를 미리 만들어 놓으면 안 됩니다. 그래야 처음 이미지를 실행시킬 때 mysql 내부에 있는 `/var/lib/mysql` 파일들을 호스트 컴퓨터로 공유받을 수 있어요.

```bash
올바른 순서:
1. docker-mysql 폴더만 생성
2. mysql_data 폴더는 생성하지 않음
3. Docker 실행 시 자동으로 mysql_data 폴더 생성됨

잘못된 순서 (피해야 할 것):
1. docker-mysql 폴더 생성
2. mysql_data 폴더까지 미리 생성 ❌
3. Docker 실행 시 빈 폴더가 컨테이너 내용을 덮어씀
```

### **볼륨 동작 과정 상세**

```
mysql_data 폴더가 없을 때:
┌─────────────────────────────────────────────────┐
│ 1. Docker가 mysql_data 폴더 자동 생성           │
│ 2. 컨테이너의 /var/lib/mysql 내용을 복사        │
│ 3. 호스트 폴더와 컨테이너 폴더 연결             │
└─────────────────────────────────────────────────┘

결과:
$ ls mysql_data/
auto.cnf  ca-key.pem  ca.pem  ib_logfile0  ib_logfile1  
ibdata1  mysql/  performance_schema/  sys/

mysql_data 폴더가 미리 있을 때:
┌─────────────────────────────────────────────────┐
│ 1. 기존 mysql_data 폴더 사용                    │
│ 2. 호스트의 빈 폴더가 컨테이너 폴더를 덮어씀    │
│ 3. MySQL 초기화 파일들이 없어서 실행 실패       │
└─────────────────────────────────────────────────┘

결과:
MySQL 컨테이너가 정상 시작되지 않음
```

### **MySQL 데이터 저장 위치**

DB에 관련된 데이터가 저장되는 곳이 `/var/lib/mysql`인지는 Docker Hub MySQL의 공식 문서에 나와있어요.

```
MySQL 데이터 구조:
/var/lib/mysql/
├── auto.cnf                *# 서버 ID*
├── ca-key.pem             *# SSL 인증서*
├── ca.pem
├── ib_logfile0            *# InnoDB 로그*
├── ib_logfile1
├── ibdata1                *# InnoDB 시스템 테이블스페이스*
├── mysql/                 *# 시스템 데이터베이스*
├── performance_schema/    *# 성능 스키마*
├── sys/                   *# sys 스키마*
└── [사용자 데이터베이스]/ *# 생성한 데이터베이스들*
```

### 2. MySQL 컨테이너에 접속해서 데이터베이스 만들기

```bash
$ docker exec -it [MySQL 컨테이너 ID] bash

$ mysql -u root -p

mysql> show databases;
mysql> create database mydb;
mysql> show databases;
```

### **실제 데이터베이스 생성 과정**

```bash
컨테이너 접속:
$ docker ps
CONTAINER ID   IMAGE   COMMAND                  CREATED         STATUS         PORTS                    NAMES
abc123def456   mysql   "docker-entrypoint.s…"   2 minutes ago   Up 2 minutes   0.0.0.0:3306->3306/tcp   amazing_curie

$ docker exec -it abc123def456 bash
root@abc123def456:/*#* 

MySQL 접속:
root@abc123def456:/*# mysql -u root -p*
Enter password: password123

기본 데이터베이스 확인:
mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
4 rows in set (0.01 sec)

새 데이터베이스 생성:
mysql> create database mydb;
Query OK, 1 row affected (0.01 sec)

mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mydb               |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
5 rows in set (0.00 sec)

추가 테스트 데이터 생성:
mysql> use mydb;
mysql> create table users (id int, name varchar(50));
mysql> insert into users values (1, 'Alice'), (2, 'Bob');
mysql> select * from users;
+------+-------+
| id   | name  |
+------+-------+
|    1 | Alice |
|    2 | Bob   |
+------+-------+
```

### **호스트에서 변경사항 확인**

```bash
호스트 파일시스템에서 확인:
$ ls mysql_data/
auto.cnf  ca-key.pem  ca.pem  ib_logfile0  ib_logfile1  
ibdata1  mydb/  mysql/  performance_schema/  sys/

mydb 폴더가 생성됨:
$ ls mysql_data/mydb/
users.ibd  *# users 테이블 데이터 파일*

실시간 동기화:
MySQL에서 데이터 변경 → 즉시 호스트 폴더에 반영
호스트 폴더 변경 → 즉시 MySQL에서 인식
```

### 3. 컨테이너 종료 후 다시 생성해보기

```bash
*# 컨테이너 종료*
$ docker stop [MySQL 컨테이너 ID]
$ docker rm [MySQL 컨테이너 ID]

*# 컨테이너 생성*
$ docker run -e MYSQL_ROOT_PASSWORD=password123 -p 3306:3306 -v /Users/jaeseong/Documents/Develop/docker-mysql/mysql_data:/var/lib/mysql -d mysql

$ docker exec -it [MySQL 컨테이너 ID] bash
$ mysql -u root -p
mysql> show databases; *# 아까 생성한 데이터베이스가 그대로 존재하는 걸 확인할 수 있다.*
```

### **데이터 영속성 확인 과정**

```bash
컨테이너 완전 삭제:
$ docker stop abc123def456
abc123def456

$ docker rm abc123def456  
abc123def456

$ docker ps -a
CONTAINER ID   IMAGE   COMMAND   CREATED   STATUS    PORTS   NAMES
*# 컨테이너가 완전히 삭제됨*

새 컨테이너 생성 (동일한 볼륨 사용):
$ docker run -e MYSQL_ROOT_PASSWORD=password123 -p 3306:3306 -v /Users/jaeseong/Documents/Develop/docker-mysql/mysql_data:/var/lib/mysql -d mysql
def456abc123

새 컨테이너에서 데이터 확인:
$ docker exec -it def456abc123 bash
root@def456abc123:/*# mysql -u root -p*
Enter password: password123

mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mydb               |  ← 이전 데이터가 그대로 있음!
| mysql              |
| performance_schema |
| sys                |
+--------------------+

mysql> use mydb;
mysql> select * from users;
+------+-------+
| id   | name  |
+------+-------+
|    1 | Alice |  ← 데이터도 그대로 보존됨!
|    2 | Bob   |
+------+-------+
```

### 4. MySQL 컨테이너 삭제하고 다시 띄워보기

```bash
*# 컨테이너 종료*
$ docker stop [MySQL 컨테이너 ID]
$ docker rm [MySQL 컨테이너 ID]

*# 비밀번호 바꿔서 컨테이너 생성*
$ docker run -e MYSQL_ROOT_PASSWORD=pwd1234 -p 3306:3306 -v /Users/jaeseong/Documents/Develop/docker-mysql/mysql_data:/var/lib/mysql -d mysql

$ docker exec -it [MySQL 컨테이너 ID] bash
$ mysql -u root -p *# 접속이 안 됨...*
```

### **비밀번호가 변경되지 않는 이유**

분명 `MYSQL_ROOT_PASSWORD` 값을 바꿔서 새로 컨테이너를 띄웠는데 비밀번호는 바뀌지 않은 걸까요? 이 부분 때문에 많은 분들이 헤매요.

**그 이유는 Volume으로 설정해둔 폴더에 이미 비밀번호 정보가 저장되어버렸기 때문이에요.**

### **MySQL 초기화 과정 상세**

```
MySQL 컨테이너 첫 실행 시:
1. /var/lib/mysql 폴더가 비어있는지 확인
2. 비어있으면 → 데이터베이스 초기화 실행
   - MYSQL_ROOT_PASSWORD로 root 비밀번호 설정
   - 시스템 데이터베이스 생성
   - 사용자 권한 테이블 생성
3. 비어있지 않으면 → 기존 데이터 사용
   - 환경 변수 무시
   - 기존 비밀번호 유지

두 번째 실행부터:
mysql_data 폴더에 이미 데이터가 있음
→ 초기화 과정 생략
→ MYSQL_ROOT_PASSWORD 환경 변수 무시
→ 기존 비밀번호(password123) 유지
```

### **비밀번호 변경이 안 되는 상황 해결**

```bash
방법 1: 볼륨 데이터 완전 삭제
$ docker stop mysql-container
$ docker rm mysql-container
$ rm -rf /Users/jaeseong/Documents/Develop/docker-mysql/mysql_data
$ docker run -e MYSQL_ROOT_PASSWORD=pwd1234 -p 3306:3306 -v /Users/jaeseong/Documents/Develop/docker-mysql/mysql_data:/var/lib/mysql -d mysql

방법 2: MySQL 내부에서 비밀번호 변경
$ docker exec -it mysql-container mysql -u root -p
*# 기존 비밀번호(password123) 입력*
mysql> ALTER USER 'root'@'localhost' IDENTIFIED BY 'pwd1234';
mysql> ALTER USER 'root'@'%' IDENTIFIED BY 'pwd1234';
mysql> FLUSH PRIVILEGES;

방법 3: 다른 볼륨 경로 사용
$ docker run -e MYSQL_ROOT_PASSWORD=pwd1234 -p 3306:3306 -v /Users/jaeseong/Documents/Develop/docker-mysql/mysql_data_new:/var/lib/mysql -d mysql
```

### **환경 변수 동작 이해**

```bash
MYSQL_ROOT_PASSWORD 환경 변수의 역할:
┌─────────────────────────────────────────────────┐
│ 데이터베이스 초기화 시에만 사용됨               │
│                                                │
│ 첫 실행: 환경 변수로 비밀번호 설정              │
│ 이후 실행: 저장된 데이터의 비밀번호 사용         │
└─────────────────────────────────────────────────┘

확인 방법:
$ docker exec -it mysql-container env | grep MYSQL
MYSQL_ROOT_PASSWORD=pwd1234  *# 환경 변수는 변경됨*

$ docker exec -it mysql-container mysql -u root -ppwd1234
ERROR 1045 (28000): Access denied for user 'root'@'localhost' (using password: YES)

$ docker exec -it mysql-container mysql -u root -ppassword123
mysql>  *# 기존 비밀번호로는 접속됨*
```

### 5. 실무 팁과 베스트 프랙티스

### **MySQL 볼륨 관리 권장사항**

```bash
프로덕션 환경:
1. Named Volume 사용 권장
$ docker volume create mysql-prod-data
$ docker run -e MYSQL_ROOT_PASSWORD=secure123 -v mysql-prod-data:/var/lib/mysql mysql

2. 정기 백업 설정
$ docker exec mysql-container mysqldump -u root -p --all-databases > backup.sql

3. 설정 파일 분리
$ docker run -v ~/mysql-config:/etc/mysql/conf.d -v mysql-data:/var/lib/mysql mysql

개발 환경:
1. Bind Mount로 편리한 관리
$ docker run -v $(pwd)/mysql-data:/var/lib/mysql mysql

2. Docker Compose 사용
version: '3'
services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: password123
    volumes:
      - ./mysql-data:/var/lib/mysql
    ports:
      - "3306:3306"
```

### **문제 해결 체크리스트**

```
MySQL 컨테이너 문제 해결:

1. 컨테이너가 시작되지 않을 때:
$ docker logs [container-id]  *# 로그 확인*

2. 접속이 안 될 때:
- 포트 매핑 확인: docker ps
- 비밀번호 확인: 볼륨 데이터의 영향
- 네트워크 확인: telnet localhost 3306

3. 데이터가 사라졌을 때:
- 볼륨 경로 확인
- 권한 문제 확인: ls -la mysql-data/
- 마운트 확인: docker inspect [container-id]

4. 성능 문제:
- 메모리 제한: docker stats
- 설정 파일: my.cnf 튜닝
- 볼륨 타입: Named Volume vs Bind Mount
```