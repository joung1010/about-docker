## Docker로 PostgreSQL 실행시켜보기

### 1. PostgreSQL 이미지를 바탕으로 컨테이너 실행시키기

```bash
$ cd /Users/jaeseong/Documents/Develop
$ mkdir docker-postgresql

$ docker run -e POSTGRES_PASSWORD=password123 -p 5432:5432 -v /Users/jaeseong/Documents/Develop/docker-postgresql/postgresql_data:/var/lib/postgresql/data -d postgres
```

### **명령어 상세 분석**

```bash
docker run 옵션 분석:
-e POSTGRES_PASSWORD=password123: PostgreSQL 슈퍼유저 비밀번호 설정
-p 5432:5432: 포트 매핑 (PostgreSQL 기본 포트)
-v [호스트경로]:/var/lib/postgresql/data: 데이터 디렉토리 볼륨 마운트
-d: 백그라운드 실행
postgres: PostgreSQL 공식 이미지 (postgres:latest)
```

### **PostgreSQL vs MySQL 환경 변수 차이**

```bash
PostgreSQL 주요 환경 변수:
POSTGRES_PASSWORD: postgres 사용자 비밀번호 (필수)
POSTGRES_USER: 기본 사용자명 (기본값: postgres)
POSTGRES_DB: 초기 생성할 데이터베이스명
POSTGRES_INITDB_ARGS: initdb 추가 옵션
POSTGRES_INITDB_WALDIR: WAL 디렉토리 위치
POSTGRES_HOST_AUTH_METHOD: 인증 방법 (trust, md5, scram-sha-256)

vs MySQL:
MYSQL_ROOT_PASSWORD (MySQL) ↔ POSTGRES_PASSWORD (PostgreSQL)
MYSQL_DATABASE (MySQL) ↔ POSTGRES_DB (PostgreSQL)
MYSQL_USER (MySQL) ↔ POSTGRES_USER (PostgreSQL)

복합 설정 예시:
$ docker run -d \
  --name postgres-server \
  -e POSTGRES_PASSWORD=password123 \
  -e POSTGRES_USER=myuser \
  -e POSTGRES_DB=myapp \
  -p 5432:5432 \
  -v ~/docker-postgresql/postgresql_data:/var/lib/postgresql/data \
  postgres:15
```

### **PostgreSQL 데이터 디렉토리**

```bash
PostgreSQL 데이터 저장 위치:
/var/lib/postgresql/data/

MySQL과 비교:
MySQL: /var/lib/mysql
PostgreSQL: /var/lib/postgresql/data

PostgreSQL 데이터 구조:
/var/lib/postgresql/data/
├── postgresql.conf      *# 메인 설정 파일*
├── pg_hba.conf         *# 클라이언트 인증 설정*
├── pg_ident.conf       *# 사용자 매핑 설정*
├── PG_VERSION          *# PostgreSQL 버전 정보*
├── base/               *# 데이터베이스별 데이터*
├── global/             *# 글로벌 데이터 (사용자, 역할 등)*
├── pg_wal/            *# WAL (Write-Ahead Log) 파일*
├── pg_xact/           *# 트랜잭션 상태 파일*
└── pg_stat_tmp/       *# 임시 통계 파일*
```

### 2. 컨테이너가 잘 실행되고 있는지 체크

```bash
$ docker ps
```

### **PostgreSQL 컨테이너 상태 확인**

```bash
출력 예시:
CONTAINER ID   IMAGE      COMMAND                  CREATED         STATUS         PORTS                    NAMES
abc123def456   postgres   "docker-entrypoint.s…"   2 minutes ago   Up 2 minutes   0.0.0.0:5432->5432/tcp   amazing_postgres

상태 확인 포인트:
- STATUS: "Up 2 minutes" (정상 실행 중)
- PORTS: "0.0.0.0:5432->5432/tcp" (포트 매핑 정상)
- COMMAND: "docker-entrypoint.s..." (PostgreSQL 시작 스크립트)

PostgreSQL 프로세스 확인:
$ docker exec abc123def456 ps aux
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
postgres       1  0.0  0.4  213904 27776 ?       Ss   10:30   0:00 postgres
postgres      75  0.0  0.1  213904  4352 ?       Ss   10:30   0:00 postgres: checkpointer
postgres      76  0.0  0.1  213904  4352 ?       Ss   10:30   0:00 postgres: background writer
postgres      77  0.0  0.1  213904  4352 ?       Ss   10:30   0:00 postgres: walwriter
postgres      78  0.0  0.1  214444  4864 ?       Ss   10:30   0:00 postgres: autovacuum launcher
postgres      79  0.0  0.1  68756   3712 ?       Ss   10:30   0:00 postgres: stats collector
postgres      80  0.0  0.1  214444  4608 ?       Ss   10:30   0:00 postgres: logical replication launcher
```

### 3. 컨테이너 실행시킬 때 에러 없이 잘 실행됐는지 로그 체크

```bash
$ docker logs [컨테이너 ID 또는 컨테이너명]
```

### **PostgreSQL 초기화 로그 분석**

```bash
PostgreSQL 정상 시작 로그:
$ docker logs abc123def456

The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The database cluster will be initialized with locale "en_US.utf8".
The default database encoding has accordingly been set to "UTF8".
The default text search configuration will be set to "english".

Data page checksums are disabled.

fixing permissions on existing directory /var/lib/postgresql/data ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default time zone ... Etc/UTC
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
syncing data to disk ... ok

initdb: warning: enabling "trust" authentication for local connections
You can change this by editing pg_hba.conf or using the option -A, or
--auth-local and --auth-host, the next time you run initdb.

Success. You can now start the database server using:
    pg_ctl -D /var/lib/postgresql/data -l logfile start

waiting for server to start....2023-11-15 10:30:45.123 UTC [46] LOG:  starting PostgreSQL 15.5 on x86_64-pc-linux-gnu
2023-11-15 10:30:45.124 UTC [46] LOG:  listening on Unix socket "/var/run/postgresql/.s.PGSQL.5432"
2023-11-15 10:30:45.127 UTC [49] LOG:  database system was shut down at 2023-11-15 10:30:44 UTC
2023-11-15 10:30:45.131 UTC [46] LOG:  database system is ready to accept connections
 done
server started

핵심 메시지:
"database system is ready to accept connections" - 연결 대기 상태
"PostgreSQL 15.5" - 버전 정보
"listening on Unix socket" - 소켓 준비 완료
```

### **일반적인 에러와 해결 방법**

```bash
환경 변수 누락 에러:
Error: Database is uninitialized and superuser password is not specified.
해결: POSTGRES_PASSWORD 환경 변수 설정 필요

포트 충돌 에러:
Error starting userland proxy: listen tcp4 0.0.0.0:5432: bind: address already in use
해결: 다른 포트 사용 (-p 5433:5432)

권한 문제:
initdb: error: could not create directory "/var/lib/postgresql/data": Permission denied
해결: 볼륨 디렉토리 권한 조정 또는 Named Volume 사용

데이터 디렉토리 문제:
initdb: error: directory "/var/lib/postgresql/data" exists but is not empty
해결: 빈 디렉토리 사용 또는 기존 데이터 정리
```

### 4. PostgreSQL 컨테이너에 접속

```bash
$ docker exec -it [컨테이너 ID 또는 컨테이너명] bash
```

### **컨테이너 접속 과정**

```bash
PostgreSQL 컨테이너 접속:
$ docker exec -it abc123def456 bash
postgres@abc123def456:/$ 

프롬프트 분석:
- postgres: 기본 사용자 (MySQL의 root와 다름)
- @abc123def456: 컨테이너 호스트명
- :/: 현재 위치 (루트 디렉토리)
- $: 일반 사용자 프롬프트 (root가 아님)

PostgreSQL 사용자 확인:
postgres@abc123def456:/$ whoami
postgres

postgres@abc123def456:/$ id
uid=999(postgres) gid=999(postgres) groups=999(postgres),101(ssl-cert)
```

### 5. PostgreSQL 연결해보기

### **psql 클라이언트 사용**

```bash
컨테이너 내부에서 psql 접속:
postgres@abc123def456:/$ psql -U postgres
psql (15.5 (Debian 15.5-1.pgdg120+1))
Type "help" for help.

postgres=*#* 

프롬프트 의미:
- postgres: 연결된 데이터베이스명
- =*#: 슈퍼유저 프롬프트 (일반 사용자는 =>)*

기본 명령어 실습:
postgres=*# \l*
                                                List of databases
   Name    |  Owner   | Encoding |  Collate   |   Ctype    | ICU Locale | Locale Provider |   Access privileges   
-----------+----------+----------+------------+------------+------------+-----------------+-----------------------
 postgres  | postgres | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            | 
 template0 | postgres | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            | =c/postgres          +
           |          |          |            |            |            |                 | postgres=CTc/postgres
 template1 | postgres | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            | =c/postgres          +
           |          |          |            |            |            |                 | postgres=CTc/postgres
(3 rows)

postgres=*# \du*
                                   List of roles
 Role name |                         Attributes                         | Member of 
-----------+------------------------------------------------------------+-----------
 postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}

데이터베이스 생성:
postgres=*# CREATE DATABASE myapp;*
CREATE DATABASE

postgres=*# \c myapp*
You are now connected to database "myapp" as user "postgres".

myapp=*# CREATE TABLE users (*
myapp(*#     id SERIAL PRIMARY KEY,*
myapp(*#     name VARCHAR(50) NOT NULL,*
myapp(*#     email VARCHAR(100) UNIQUE,*
myapp(*#     created_at TIMESTAMP DEFAULT NOW()*
myapp(*# );*
CREATE TABLE

myapp=*# INSERT INTO users (name, email) VALUES* 
myapp-*#     ('Alice', 'alice@example.com'),*
myapp-*#     ('Bob', 'bob@example.com'),*
myapp-*#     ('Charlie', 'charlie@example.com');*
INSERT 0 3

myapp=*# SELECT * FROM users;*
 id |  name   |       email       |         created_at         
----+---------+-------------------+----------------------------
  1 | Alice   | alice@example.com | 2023-11-15 10:35:23.456789
  2 | Bob     | bob@example.com   | 2023-11-15 10:35:23.456789
  3 | Charlie | charlie@example.com| 2023-11-15 10:35:23.456789
(3 rows)
```

### 6. PostgreSQL 데이터가 볼륨에 잘 저장되고 있는지 확인해보기

bash

```bash
$ cd /Users/jeonghwanpark/Enviroment/docker-postgres
$ ls
```

### **볼륨 데이터 확인**

```bash
PostgreSQL 데이터 파일 구조:
$ ls -la postgresql_data/
total 128
drwx------ 19 999  999   4096 Nov 15 10:30 .
drwxr-xr-x  3 user user  4096 Nov 15 10:30 ..
-rw-------  1 999  999      3 Nov 15 10:30 PG_VERSION
-rw-------  1 999  999     88 Nov 15 10:30 postgresql.auto.conf
-rw-------  1 999  999  29188 Nov 15 10:30 postgresql.conf
-rw-------  1 999  999   1636 Nov 15 10:30 pg_hba.conf
-rw-------  1 999  999   1592 Nov 15 10:30 pg_ident.conf
-rw-------  1 999  999     58 Nov 15 10:30 postmaster.opts
-rw-------  1 999  999     94 Nov 15 10:30 postmaster.pid
drwx------  6 999  999   4096 Nov 15 10:30 base
drwx------  2 999  999   4096 Nov 15 10:35 global
drwx------  2 999  999   4096 Nov 15 10:30 pg_commit_ts
drwx------  2 999  999   4096 Nov 15 10:30 pg_dynshmem
drwx------  4 999  999   4096 Nov 15 10:30 pg_logical
drwx------  4 999  999   4096 Nov 15 10:30 pg_multixact
drwx------  2 999  999   4096 Nov 15 10:30 pg_notify
drwx------  2 999  999   4096 Nov 15 10:30 pg_replslot
drwx------  2 999  999   4096 Nov 15 10:30 pg_serial
drwx------  2 999  999   4096 Nov 15 10:30 pg_snapshots
drwx------  2 999  999   4096 Nov 15 10:30 pg_stat
drwx------  2 999  999   4096 Nov 15 10:35 pg_stat_tmp
drwx------  2 999  999   4096 Nov 15 10:30 pg_subtrans
drwx------  2 999  999   4096 Nov 15 10:30 pg_tblspc
drwx------  2 999  999   4096 Nov 15 10:30 pg_twophase
drwx------  3 999  999   4096 Nov 15 10:30 pg_wal
drwx------  2 999  999   4096 Nov 15 10:30 pg_xact

주요 디렉토리:
- base/: 각 데이터베이스의 실제 데이터 파일
- global/: 전역 카탈로그 (사용자, 역할, 테이블스페이스)
- pg_wal/: Write-Ahead Log (트랜잭션 로그)
- pg_xact/: 트랜잭션 상태 정보

설정 파일:
- postgresql.conf: 메인 설정 파일
- pg_hba.conf: 클라이언트 인증 설정
- pg_ident.conf: 사용자 매핑 설정
```

### 7. 데이터 영속성 테스트

### **컨테이너 재생성 테스트**

```bash
컨테이너 삭제:
$ docker stop abc123def456
$ docker rm abc123def456

새 컨테이너 생성 (같은 볼륨 사용):
$ docker run -e POSTGRES_PASSWORD=password123 -p 5432:5432 -v /Users/jaeseong/Documents/Develop/docker-postgresql/postgresql_data:/var/lib/postgresql/data -d postgres
def456abc123

데이터 보존 확인:
$ docker exec -it def456abc123 psql -U postgres -d myapp
myapp=*# SELECT * FROM users;*
 id |  name   |       email       |         created_at         
----+---------+-------------------+----------------------------
  1 | Alice   | alice@example.com | 2023-11-15 10:35:23.456789
  2 | Bob     | bob@example.com   | 2023-11-15 10:35:23.456789
  3 | Charlie | charlie@example.com| 2023-11-15 10:35:23.456789
(3 rows)

*# 데이터가 완벽하게 보존됨!*
```

### 8. PostgreSQL 설정 관리

### **커스텀 설정 파일**

```bash
PostgreSQL 설정 커스터마이징:
$ mkdir -p ~/postgres-config
$ cat > ~/postgres-config/postgresql.conf << EOF
# 성능 튜닝
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
work_mem = 4MB

# 연결 설정
max_connections = 200
listen_addresses = '*'

# 로깅
log_destination = 'stderr'
logging_collector = on
log_directory = 'pg_log'
log_statement = 'all'
EOF

설정 파일과 함께 실행:
$ docker run -d \
  --name postgres-custom \
  -e POSTGRES_PASSWORD=password123 \
  -v ~/postgres-config/postgresql.conf:/etc/postgresql/postgresql.conf \
  -v ~/postgresql_data:/var/lib/postgresql/data \
  -p 5432:5432 \
  postgres:15 -c 'config_file=/etc/postgresql/postgresql.conf'
```