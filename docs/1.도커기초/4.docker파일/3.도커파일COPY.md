## COPY : 파일 복사(이동)

### 의미

`COPY`는 **호스트 컴퓨터**에 있는 파일을 복사해서 **컨테이너**로 전달해요.

### 사용법

docker

```bash
*# 문법*
COPY [호스트 컴퓨터에 있는 복사할 파일의 경로] [컨테이너에서 파일이 위치할 경로]

*# 예시*
COPY app.txt /app.txt
```

### **COPY 명령어 동작 원리**

```
COPY 실행 과정:
1. Docker 빌드 컨텍스트에서 파일 찾기
2. 파일을 새로운 이미지 레이어로 복사
3. 컨테이너 파일시스템에 파일 배치

빌드 컨텍스트:
┌─────────────────────────────────────────────────┐
│              Host Directory                     │
│  ├── Dockerfile                                │
│  ├── app.txt                                   │
│  ├── my-app/                                   │
│  │   ├── index.js                             │
│  │   └── package.json                         │
│  └── .dockerignore                             │
└─────────────────────────────────────────────────┘
                        ↓ COPY
┌─────────────────────────────────────────────────┐
│              Container Image                    │
│  ├── /app.txt                                  │
│  ├── /my-app/                                  │
│  │   ├── index.js                             │
│  │   └── package.json                         │
│  └── (기존 베이스 이미지 파일들)                │
└─────────────────────────────────────────────────┘
```

## 파일 복사해보기

### 1. app.txt 파일 만들기

```
프로젝트 디렉토리 구성:
$ mkdir docker-copy-example
$ cd docker-copy-example
$ echo "Hello from app.txt!" > app.txt
$ cat app.txt
Hello from app.txt!
```

### 2. Dockerfile 만들어서 이미지 생성 및 컨테이너 실행

**Dockerfile**

```
FROM ubuntu

COPY app.txt /app.txt

ENTRYPOINT ["/bin/bash", "-c", "sleep 500"] # 디버깅용 코드
```

```bash
$ docker build -t my-server .
$ docker run -d my-server
$ docker exec -it [Container ID] bash

$ ls
```

### **실행 결과 분석**

```bash
컨테이너 내부 확인:
root@abc123def456:/*# ls -la*
total 72
drwxr-xr-x   1 root root 4096 Nov 15 10:30 .
drwxr-xr-x   1 root root 4096 Nov 15 10:30 ..
-rw-r--r--   1 root root   20 Nov 15 10:30 app.txt  ← 복사된 파일
drwxr-xr-x   2 root root 4096 Nov 15 10:30 bin
drwxr-xr-x   2 root root 4096 Nov 15 10:30 boot
...

root@abc123def456:/*# cat app.txt*
Hello from app.txt!

파일 권한 확인:
root@abc123def456:/*# ls -la app.txt*
-rw-r--r-- 1 root root 20 Nov 15 10:30 app.txt
*# 소유자: root, 그룹: root, 권한: 644*
```

## 폴더 안에 있는 모든 파일들 복사

### 1. `my-app` 디렉터리 만들기, `my-app` 디렉터리 안에 파일 만들기

```bash
디렉토리 및 파일 생성:
$ mkdir my-app
$ echo "console.log('Hello World!');" > my-app/index.js
$ echo '{"name": "my-app", "version": "1.0.0"}' > my-app/package.json
$ echo "This is README" > my-app/README.md

디렉토리 구조 확인:
$ tree
.
├── Dockerfile
├── app.txt
└── my-app
    ├── README.md
    ├── index.js
    └── package.json
```

### 2. Dockerfile 만들어서 이미지 생성 및 컨테이너 실행

**Dockerfile**

```bash
FROM ubuntu

COPY my-app /my-app/

ENTRYPOINT ["/bin/bash", "-c", "sleep 500"] # 디버깅용 코드
```

### **폴더 복사 시 경로 주의사항**

```
경로 처리 방식:
COPY my-app /my-app/     ← 권장 (명확한 디렉토리 복사)
COPY my-app /my-app      ← 가능하지만 혼동 여지

결과:
/my-app/
├── README.md
├── index.js
└── package.json

잘못된 예:
COPY my-app/ /my-app     ← my-app 내용물만 복사됨
결과: /my-app가 파일이 됨 (디렉토리가 아닌)
```

### **실행 및 확인**

```bash
$ docker build -t my-server .
$ docker run -d my-server
$ docker exec -it [Container ID] bash

컨테이너 내부 확인:
root@abc123def456:/*# ls -la my-app/*
total 20
drwxr-xr-x 2 root root 4096 Nov 15 10:35 .
drwxr-xr-x 1 root root 4096 Nov 15 10:35 ..
-rw-r--r-- 1 root root   15 Nov 15 10:35 README.md
-rw-r--r-- 1 root root   29 Nov 15 10:35 index.js
-rw-r--r-- 1 root root   38 Nov 15 10:35 package.json
```

## 와일드카드 사용해보기

### 1. `app.txt`, `readme.txt` 파일 2개 만들기

```bash
텍스트 파일들 생성:
$ echo "Application content" > app.txt
$ echo "This is readme" > readme.txt  
$ echo "Configuration data" > config.txt
$ ls *.txt
app.txt  config.txt  readme.txt
```

### 2. Dockerfile 만들어서 이미지 생성 및 컨테이너 실행

**Dockerfile**

```bash
FROM ubuntu

COPY *.txt /text-files/

ENTRYPOINT ["/bin/bash", "-c", "sleep 500"] # 디버깅용 코드
```

**주의)** `/text-files`라고 적으면 안 되고 `/text-files/`라고 적어야 `text-files`라는 디렉토리 안에 파일들이 정상적으로 복사돼요.

### **와일드카드 패턴들**

```bash
다양한 와일드카드 패턴:
COPY *.txt /text-files/          *# 모든 .txt 파일*
COPY app.* /app-files/           *# app으로 시작하는 모든 파일*
COPY src/**/*.js /js-files/      *# src 하위 모든 .js 파일 (재귀적)*
COPY [abc]*.txt /files/          *# a, b, c로 시작하는 .txt 파일*
COPY *.{js,css} /assets/         *# .js와 .css 파일들*

주의사항:
- 와일드카드는 빌드 컨텍스트 내에서만 동작
- 대상 경로가 디렉토리면 반드시 /로 끝내기
- 여러 파일 복사 시 대상은 반드시 디렉토리여야 함
```

### **실행 및 확인**

```bash
$ docker build -t my-server .
$ docker run -d my-server
$ docker exec -it [Container ID] bash

$ ls /text-files/
app.txt  config.txt  readme.txt
```

## `.dockerignore` 사용해보기

특정 파일 또는 폴더만 `COPY`를 하고 싶지 않을 수 있어요. 그럴 때 `.dockerignore`를 활용해요.

### 1. `.dockerignore` 파일 만들기

**.dockerignore**

```bash
readme.txt
node_modules/
.git/
*.log
.env
```

### **`.dockerignore` 패턴**

bash

```bash
.dockerignore 패턴 예시:
*# 특정 파일 제외*
readme.txt
config.json

*# 특정 디렉토리 제외*  
node_modules/
.git/
build/

*# 패턴 매칭*
*.log           *# 모든 .log 파일*
*.tmp           *# 모든 .tmp 파일*  
**/*.test.js    *# 모든 .test.js 파일 (재귀적)# 예외 처리 (!)*
*.txt           *# 모든 .txt 파일 제외*
!important.txt  *# 단, important.txt는 포함# 주석# This is a comment*
```

### 2. Dockerfile 만들어서 이미지 생성 및 컨테이너 실행

**Dockerfile**

```bash
FROM ubuntu

COPY ./ /

ENTRYPOINT ["/bin/bash", "-c", "sleep 500"] # 디버깅용 코드
```

bash

```bash
$ docker build -t my-server .
$ docker run -d my-server
$ docker exec -it [Container ID] bash

$ ls
```

### **`.dockerignore` 동작 확인**

```bash
호스트 디렉토리:
$ ls
Dockerfile  app.txt  config.txt  my-app/  readme.txt

컨테이너 내부 (readme.txt가 제외됨):
root@abc123def456:/*# ls*
Dockerfile  app.txt  config.txt  my-app/  bin  boot  dev  ...

*# readme.txt가 복사되지 않음을 확인*
root@abc123def456:/*# ls -la readme.txt*
ls: cannot access 'readme.txt': No such file or directory
```

### 🎯 COPY 최적화 팁

### **레이어 캐싱 최적화**

docker

```bash
❌ 비효율적인 방법:
FROM node:18
COPY . /app          # 모든 파일 복사
WORKDIR /app
RUN npm install

*# 소스 코드 변경 시 npm install도 다시 실행됨*

✅ 효율적인 방법:
FROM node:18
WORKDIR /app
COPY package*.json ./    # 의존성 파일만 먼저 복사
RUN npm install          # 의존성 설치 (캐시됨)
COPY . .                 # 나머지 파일 복사

*# package.json이 변경되지 않으면 npm install 단계가 캐시됨*
```

### **권한 관리**

```bash
권한 설정:
FROM ubuntu
RUN groupadd -r appgroup && useradd -r -g appgroup appuser
COPY --chown=appuser:appgroup app.txt /app/app.txt

또는:
COPY app.txt /app/app.txt
RUN chown appuser:appgroup /app/app.txt
```

### **COPY vs ADD 비교**

```bash
COPY vs ADD:

COPY:
✅ 단순한 파일/디렉토리 복사
✅ 예측 가능한 동작
✅ 권장 사항

ADD:
⚠️ 자동 압축 해제 기능
⚠️ URL에서 다운로드 가능
⚠️ 예측하기 어려운 동작

권장사항: 특별한 이유가 없다면 COPY 사용
```

### **멀티스테이지 빌드와 COPY**

```bash
*# 빌드 스테이지*
FROM node:18 AS builder
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

*# 프로덕션 스테이지*
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html

*# 빌드 스테이지의 결과물만 복사*
```