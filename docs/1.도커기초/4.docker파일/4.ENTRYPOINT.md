## ENTRYPOINT : 컨테이너가 시작할 때 실행되는 명령어

### 의미

`ENTRYPOINT`는 컨테이너가 생성되고 최초로 실행할 때 수행되는 명령어를 뜻해요. 쉽게 설명하자면 `ENTRYPOINT`에는 미니 컴퓨터의 전원을 키고나서 실행시키고 싶은 명령어를 적으면 돼요.

명령어는 일반적으로 리눅스 명령어를 적으면 돼요.

### 사용법

```bash
*# 문법*
ENTRYPOINT [명령문...]

*# 예시*
ENTRYPOINT ["node", "dist/main.js"]
```

### **ENTRYPOINT 형태**

```bash
ENTRYPOINT의 두 가지 형태:

1. Exec 형태 (권장):
ENTRYPOINT ["executable", "param1", "param2"]
ENTRYPOINT ["node", "app.js"]
ENTRYPOINT ["/bin/bash", "-c", "echo hello"]

2. Shell 형태:
ENTRYPOINT command param1 param2
ENTRYPOINT node app.js
ENTRYPOINT echo hello

차이점:
Exec 형태: 프로세스가 PID 1로 직접 실행됨
Shell 형태: /bin/sh -c를 통해 실행됨 (PID 1이 sh)
```

## 예제

**Dockerfile**

```bash
FROM ubuntu

ENTRYPOINT ["/bin/bash", "-c", "echo hello"]
```

```bash
$ docker build -t my-server .
$ docker run -d my-server
$ docker ps -a
$ docker logs [Container ID]
```

### **실행 결과 분석**

```bash
빌드 및 실행:
$ docker build -t my-server .
$ docker run -d my-server
abc123def456

컨테이너 상태 확인:
$ docker ps -a
CONTAINER ID   IMAGE      COMMAND                  CREATED         STATUS                     PORTS   NAMES
abc123def456   my-server  "/bin/bash -c 'echo …"   1 minute ago    Exited (0) 1 minute ago            amazing_name

로그 확인:
$ docker logs abc123def456
hello

동작 과정:
1. 컨테이너 시작
2. ENTRYPOINT 명령어 실행: echo hello
3. "hello" 출력 후 프로세스 종료
4. 메인 프로세스가 종료되었으므로 컨테이너도 종료 (Exited)
```

### 🔄 ENTRYPOINT vs CMD

### **주요 차이점**

```bash
ENTRYPOINT vs CMD:

ENTRYPOINT:
- 항상 실행되는 고정 명령어
- docker run 시 덮어쓸 수 없음
- 컨테이너의 기본 실행 파일 역할

CMD:
- 기본 명령어 또는 매개변수
- docker run 시 쉽게 덮어쓸 수 있음
- ENTRYPOINT가 없으면 메인 명령어 역할

예시 1 - ENTRYPOINT만 사용:
FROM ubuntu
ENTRYPOINT ["echo", "Hello"]

$ docker run my-image
Hello
$ docker run my-image World    *# "World"가 매개변수로 전달됨*
Hello World

예시 2 - CMD만 사용:
FROM ubuntu
CMD ["echo", "Hello"]

$ docker run my-image
Hello
$ docker run my-image echo "Goodbye"    *# CMD가 완전히 대체됨*
Goodbye

예시 3 - ENTRYPOINT + CMD 조합:
FROM ubuntu  
ENTRYPOINT ["echo"]
CMD ["Hello"]

$ docker run my-image
Hello
$ docker run my-image "World"    *# CMD가 "World"로 대체됨*
World
```

### 💻 다양한 ENTRYPOINT 활용 예시

### **웹서버 실행**

```bash
Node.js 서버:
FROM node:18
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
ENTRYPOINT ["node", "server.js"]

Python Flask 서버:
FROM python:3.11
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
ENTRYPOINT ["python", "app.py"]

Java Spring Boot:
FROM openjdk:17-jdk
WORKDIR /app
COPY target/app.jar app.jar
ENTRYPOINT ["java", "-jar", "app.jar"]
```

### **데이터베이스 서버**

```bash
MySQL과 유사한 패턴:
FROM mysql:8.0
COPY custom-config.cnf /etc/mysql/conf.d/
ENTRYPOINT ["docker-entrypoint.sh", "mysqld"]
```

### **복잡한 초기화 스크립트**

```bash
FROM ubuntu
COPY startup.sh /startup.sh
RUN chmod +x /startup.sh
ENTRYPOINT ["/startup.sh"]

startup.sh:
*#!/bin/bash*
echo "Starting initialization..."
*# 환경 변수 확인*
if [ -z "$DATABASE_URL" ]; then
  echo "DATABASE_URL not set"
  exit 1
fi

*# 데이터베이스 마이그레이션*
./migrate.sh

*# 애플리케이션 시작*
exec "$@"   # CMD 매개변수들을 실행
```

### 🛠️ ENTRYPOINT 실행 형태 상세

### **Exec 형태 vs Shell 형태**

```bash
Exec 형태의 장점:
FROM ubuntu
ENTRYPOINT ["echo", "Hello World"]

프로세스 트리:
PID 1: echo Hello World
- 직접 실행됨
- 신호 처리 정상 작동
- 더 빠른 시작

Shell 형태의 특성:
FROM ubuntu  
ENTRYPOINT echo "Hello World"

프로세스 트리:
PID 1: /bin/sh -c "echo Hello World"
  └─ PID 2: echo Hello World
- 쉘을 통해 실행됨
- 환경 변수 치환 가능
- 신호 처리 문제 발생 가능
```

### **환경 변수 사용**

```bash
Shell 형태에서 환경 변수:
FROM ubuntu
ENV NAME=Docker
ENTRYPOINT echo "Hello $NAME"
*# 결과: Hello Docker*

Exec 형태에서 환경 변수:
FROM ubuntu
ENV NAME=Docker
ENTRYPOINT ["/bin/bash", "-c", "echo Hello $NAME"]
*# 결과: Hello Docker*

또는:
FROM ubuntu
ENV NAME=Docker
ENTRYPOINT ["sh", "-c", "echo Hello ${NAME}"]
```

### 🔍 실제 사용 시나리오

### **웹 애플리케이션 배포**

```bash
FROM node:18-alpine
WORKDIR /app

*# 의존성 설치*
COPY package*.json ./
RUN npm ci --only=production

*# 애플리케이션 코드 복사*
COPY . .

*# 포트 노출*
EXPOSE 3000

*# 애플리케이션 실행*
ENTRYPOINT ["node", "index.js"]
```

### **개발 환경과 프로덕션 환경**

```bash
개발용 Dockerfile:
FROM node:18
WORKDIR /app
COPY package*.json ./
RUN npm install  # devDependencies도 포함
COPY . .
ENTRYPOINT ["npm", "run", "dev"]  # 개발 서버 실행

프로덕션용 Dockerfile:
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production  # 프로덕션 의존성만
COPY . .
ENTRYPOINT ["npm", "start"]   # 프로덕션 서버 실행
```

### **헬스체크와 함께**

```bash
FROM nginx:alpine
COPY nginx.conf /etc/nginx/nginx.conf
COPY --from=builder /app/dist /usr/share/nginx/html

HEALTHCHECK --interval=30s --timeout=3s \
  CMD curl -f http://localhost/ || exit 1

ENTRYPOINT ["nginx", "-g", "daemon off;"]
```

### 🚨 주의사항과 트러블슈팅

### **PID 1 문제**

```bash
문제: 신호 처리
잘못된 방법:
ENTRYPOINT ["sh", "-c", "my-app"]

문제점: sh가 PID 1이 되어 SIGTERM 등의 신호를 my-app에 전달하지 않음

올바른 방법:
ENTRYPOINT ["my-app"]
또는:
ENTRYPOINT ["sh", "-c", "exec my-app"]  *# exec로 프로세스 교체*
```

### **권한 문제**

```bash
권한 문제 해결:
FROM ubuntu
RUN groupadd -r appgroup && useradd -r -g appgroup appuser
COPY --chown=appuser:appgroup app.py /app/app.py
USER appuser
ENTRYPOINT ["python", "/app/app.py"]
```

### **디버깅을 위한 오버라이드**

```bash
ENTRYPOINT 오버라이드하여 디버깅:
$ docker run -it --entrypoint /bin/bash my-image

또는 임시로 다른 명령어 실행:
$ docker run -it --entrypoint="" my-image /bin/bash
```

### 📋 ENTRYPOINT 모범 사례

### **1. 명령어 형태 선택**

```bash
권장사항:
✅ Exec 형태 사용: ENTRYPOINT ["cmd", "arg1"]
❌ Shell 형태 지양: ENTRYPOINT cmd arg1

예외: 환경 변수 치환이나 쉘 기능이 필요한 경우
ENTRYPOINT ["/bin/bash", "-c", "echo $ENV_VAR && exec my-app"]
```

### **2. 유연한 설계**

```bash
베이스 명령어 + 매개변수 패턴:
FROM python:3.11
WORKDIR /app
COPY . .
ENTRYPOINT ["python", "manage.py"]
CMD ["runserver", "0.0.0.0:8000"]

사용법:
$ docker run my-django                    # python manage.py runserver 0.0.0.0:8000
$ docker run my-django migrate           # python manage.py migrate
$ docker run my-django shell             # python manage.py shell
```

### **3. 초기화 스크립트 패턴**

```bash
FROM ubuntu
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh
ENTRYPOINT ["/entrypoint.sh"]
CMD ["my-app"]

entrypoint.sh:
*#!/bin/bash*
set -e

*# 초기화 작업*
echo "Initializing..."
setup_database
configure_app

*# 메인 프로세스 실행 (CMD 매개변수들)*
exec "$@"
```