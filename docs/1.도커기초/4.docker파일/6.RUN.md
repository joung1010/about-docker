## RUN : 이미지를 생성하는 과정에서 사용할 명령문 실행

### 의미

`RUN`은 이미지 생성 과정에서 명령어를 실행시켜야 할 때 사용해요.

### 사용법

```docker
*# 문법*
RUN [명령문]

*# 예시*
RUN npm install
```

### RUN vs ENTRYPOINT

`RUN` 명령어와 `ENTRYPOINT` 명령어가 헷갈릴 때가 있어요. 둘 다 명령어를 실행시키기 때문이죠. 하지만 엄연히 둘의 사용 용도는 다릅니다. `RUN`은 '**이미지 생성 과정**'에서 필요한 명령어를 실행시킬 때 사용하고, `ENTRYPOINT`는 생성된 이미지를 기반으로 **컨테이너를 생성한 직후에** 명령어를 실행시킬 때 사용해요.

### **실행 시점 비교**

```
Docker 이미지 생성 과정:
1. FROM ubuntu              ← 베이스 이미지 선택
2. RUN apt update           ← 이미지 빌드 시 실행 (패키지 업데이트)
3. RUN apt install -y git   ← 이미지 빌드 시 실행 (git 설치)
4. 이미지 완성              ← git이 설치된 상태로 이미지 생성

컨테이너 실행 과정:
1. docker run my-image      ← 이미지를 기반으로 컨테이너 생성
2. ENTRYPOINT 실행          ← 컨테이너 시작 시 실행 (sleep 500)
3. 컨테이너 실행 중

핵심 차이:
RUN: 이미지에 영구적으로 변경사항 저장 (레이어로 추가)
ENTRYPOINT: 컨테이너마다 실행되는 시작 명령어
```

### 예제

미니 컴퓨터 환경이 ubuntu로 구성되었으면 좋겠고 git이 깔려있으면 좋겠다고 가정하죠. 이런 환경을 구성하기 위해 `Dockerfile`을 활용해 ubuntu, git이 깔려있는 이미지를 만들면 돼요.

### **1. Dockerfile 작성하기**

**Dockerfile**

docker

```docker
FROM ubuntu

RUN apt update && apt install -y git

ENTRYPOINT ["/bin/bash", "-c", "sleep 500"]
```

### **2. 이미지 빌드 및 컨테이너 실행**

```bash
$ docker build -t my-server .
$ docker run -d my-server
$ docker exec -it [Container ID] bash

$ git --version *# 컨테이너 내에 git이 잘 설치됐는지 확인*
```

### RUN 명령어 활용법

### **패키지 설치**

```docker
*# 단일 패키지 설치*
RUN apt update && apt install -y curl

*# 여러 패키지 설치*
RUN apt update && apt install -y \
    curl \
    wget \
    vim \
    git

*# Python 패키지 설치*
RUN pip install flask requests

*# Node.js 패키지 설치*
RUN npm install express
```

### **파일 시스템 조작**

```docker
*# 디렉토리 생성*
RUN mkdir -p /app/data

*# 파일 권한 변경*
RUN chmod +x /app/script.sh

*# 사용자 생성*
RUN useradd -m -s /bin/bash appuser

*# 파일 다운로드*
RUN wget https://example.com/file.tar.gz && \
    tar -xzf file.tar.gz && \
    rm file.tar.gz
```

### **환경 설정**

```docker
*# 환경 변수 설정을 위한 파일 생성*
RUN echo 'export PATH=/app/bin:$PATH' >> /etc/profile

*# 시스템 설정*
RUN echo 'Asia/Seoul' > /etc/timezone

*# 소프트웨어 컴파일*
RUN cd /tmp && \
    wget https://source-code.tar.gz && \
    tar -xzf source-code.tar.gz && \
    cd source-code && \
    ./configure && \
    make && \
    make install
```

### RUN 최적화 기법

### **레이어 최소화**

```docker
❌ 비효율적 (여러 레이어 생성):
RUN apt update
RUN apt install -y git
RUN apt install -y curl
RUN apt clean

✅ 효율적 (하나의 레이어):
RUN apt update && \
    apt install -y git curl && \
    apt clean && \
    rm -rf /var/lib/apt/lists/*
```

### **캐시 무효화 방지**

```docker
❌ 캐시 무효화 발생:
COPY package.json .
RUN npm install
COPY . .

✅ 캐시 최적화:
COPY package.json package-lock.json ./
RUN npm ci --only=production
COPY . .
```

### **멀티라인 명령어**

```docker
RUN apt update && \
    apt install -y \
        curl \
        wget \
        git \
        vim && \
    apt clean && \
    rm -rf /var/lib/apt/lists/* && \
    useradd -m appuser && \
    mkdir -p /app/logs && \
    chown appuser:appuser /app/logs
```

### 다양한 RUN 활용 사례

### **개발 환경 구성**

```docker
FROM ubuntu:22.04

*# 기본 도구 설치*
RUN apt update && apt install -y \
    build-essential \
    curl \
    git \
    vim \
    && rm -rf /var/lib/apt/lists/*

*# Node.js 설치*
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - && \
    apt install -y nodejs

*# 개발 도구 설치*
RUN npm install -g typescript nodemon

*# 작업 사용자 생성*
RUN useradd -m -s /bin/bash developer && \
    usermod -aG sudo developer
```

### **Python 환경 구성**

```docker
FROM python:3.11

*# 시스템 의존성 설치*
RUN apt update && apt install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

*# Python 패키지 설치*
RUN pip install --upgrade pip && \
    pip install \
        fastapi \
        uvicorn \
        sqlalchemy \
        pytest

*# 작업 디렉토리 설정 및 권한 조정*
RUN mkdir -p /app && \
    groupadd -r appgroup && \
    useradd -r -g appgroup appuser && \
    chown appuser:appgroup /app
```

### RUN 명령어 주의사항

```docker
보안 고려사항:
*# 민감한 정보가 레이어에 남지 않도록 주의*
RUN apt update && \
    apt install -y some-package && \
    rm -rf /var/lib/apt/lists/* \
    /tmp/* \
    /var/tmp/*

*# 불필요한 캐시 정리*
RUN pip install requirements.txt && \
    pip cache purge

*# 임시 파일 정리*
RUN wget temp-file.tar.gz && \
    tar -xzf temp-file.tar.gz && \
    rm temp-file.tar.gz
```

RUN 명령어를 잘 활용하면 필요한 도구와 환경이 모두 설정된 효율적인 Docker 이미지를 만들 수 있어요.