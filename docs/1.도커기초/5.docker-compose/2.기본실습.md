## 기본 실습

## Docker Compose Redis 실습

### Docker CLI vs Docker Compose 비교

### Docker CLI

```bash
$ docker run -d -p 6379:6379 redis
```

### Docker Compose

**compose.yml**

```yaml
services:
  my-cache-server:
    image: redis
    ports: 
      - "6379:6379"
```

**실행 및 관리**

```bash
*# 실행*
$ docker compose up -d

*# 상태 확인*
$ docker compose ps

*# 로그 확인*
$ docker compose logs my-cache-server

*# Redis 접속*
$ docker exec -it [컨테이너명] redis-cli

*# Redis 명령어 테스트*
127.0.0.1:6379> set mykey "Hello Redis"
127.0.0.1:6379> get mykey
127.0.0.1:6379> keys *
127.0.0.1:6379> exit

*# 정리*
$ docker compose down
```

## Docker Compose MySQL 실습

### 개선된 compose.yml

```yaml
services:
  my-db:
    image: mysql:8.0
    container_name: mysql-server
    environment:
      MYSQL_ROOT_PASSWORD: pwd1234
      MYSQL_DATABASE: myapp
      MYSQL_USER: appuser
      MYSQL_PASSWORD: apppass
    volumes:
      - ./mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
```

**추가 기능들:**

- `MYSQL_DATABASE`: 초기 데이터베이스 생성
- `MYSQL_USER/PASSWORD`: 애플리케이션용 사용자 생성
- `restart`: 재시작 정책
- `healthcheck`: 컨테이너 상태 확인

**실행 및 확인**

```bash
*# 실행*
$ docker compose up -d

*# 헬스체크 확인*
$ docker compose ps

*# MySQL 접속 테스트*
$ docker exec -it mysql-server mysql -u root -ppwd1234
mysql> SHOW DATABASES;
mysql> USE myapp;
mysql> exit

*# 볼륨 데이터 확인*
$ ls -la mysql_data/

*# 정리*
$ docker compose down
*# 볼륨까지 삭제하려면: docker compose down -v*
```

## Spring Boot 실습

### 개선된 Dockerfile

```docker
FROM openjdk:21-jdk-slim

*# 시스템 도구 설치*
RUN apt update && apt install -y git vim curl && \
    apt clean && rm -rf /var/lib/apt/lists/*

WORKDIR /app

*# JAR 파일 복사*
COPY build/libs/*.jar app.jar

*# 포트 노출*
EXPOSE 8080

*# 헬스체크 추가*
HEALTHCHECK --interval=30s --timeout=3s \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

ENTRYPOINT ["java", "-jar", "app.jar"]
```

### compose.yml with 의존성

```yaml
version: '3.8'

services:
  *# 데이터베이스*
  database:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: myapp
      MYSQL_USER: appuser
      MYSQL_PASSWORD: apppass
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  *# 캐시*
  cache:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      timeout: 3s
      retries: 5

  *# 애플리케이션*
  app:
    build: .
    ports:
      - "8080:8080"
    depends_on:
      database:
        condition: service_healthy
      cache:
        condition: service_healthy
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://database:3306/myapp
      - SPRING_DATASOURCE_USERNAME=appuser
      - SPRING_DATASOURCE_PASSWORD=apppass
      - SPRING_REDIS_HOST=cache
      - SPRING_REDIS_PORT=6379
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  mysql_data:

networks:
  default:
    name: myapp-network
```

### 실행 순서

```bash
*# 1. Spring Boot 빌드*
$ ./gradlew clean build -x test

*# 2. 전체 스택 실행*
$ docker compose up -d --build

*# 3. 상태 확인*
$ docker compose ps

*# 4. 로그 확인*
$ docker compose logs -f app

*# 5. 애플리케이션 테스트*
$ curl http://localhost:8080

*# 6. 개별 서비스 재시작*
$ docker compose restart app

*# 7. 스케일링 (앱 서버 여러 개)*
$ docker compose up -d --scale app=3

*# 8. 정리*
$ docker compose down
*# 볼륨 포함 삭제: docker compose down -v*
```

### 개발 환경용 override 파일

**docker-compose.override.yml** (개발용)

```yaml
version: '3.8'

services:
  app:
    volumes:
      - ./src:/app/src
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_DEVTOOLS_RESTART_ENABLED=true
    command: ["java", "-jar", "-Dspring.profiles.active=dev", "app.jar"]

  database:
    ports:
      - "3306:3306"  *# 개발 시에만 외부 접근 허용*
```