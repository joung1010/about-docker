## AWS EC2 Spring Boot Docker

## 1. Docker와 Docker Compose 기본 이해

### Docker의 핵심 개념

- **Image**: 애플리케이션과 실행 환경이 패키징된 불변의 템플릿
- **Container**: 이미지를 실행한 격리된 프로세스 인스턴스
- **Registry**: 이미지를 저장하고 배포하는 저장소 (AWS ECR, Docker Hub 등)

### Docker Compose란?

여러 컨테이너로 구성된 애플리케이션을 정의하고 실행하는 도구입니다. YAML 파일로 서비스 구성을 선언적으로 관리할 수 있습니다.

## 2. Spring Boot 애플리케이션 배포 과정

### 2.1 애플리케이션 빌드 및 이미지 생성

```bash
*# 1. Spring Boot 애플리케이션 빌드*
./gradlew clean build

*# 2. AWS ECR 로그인*
aws ecr get-login-password --region ap-northeast-2 | \
docker login --username AWS --password-stdin \
002177417362.dkr.ecr.ap-northeast-2.amazonaws.com

*# 3. Docker 이미지 빌드 (플랫폼 지정 중요!)*
docker build --platform linux/amd64 -t instagram-server .

*# 4. ECR 리포지토리에 맞게 태깅*
docker tag instagram-server:latest \
002177417362.dkr.ecr.ap-northeast-2.amazonaws.com/instagram-server:latest

*# 5. ECR에 이미지 푸시*
docker push 002177417362.dkr.ecr.ap-northeast-2.amazonaws.com/instagram-server:latest
```

### 3.2 플랫폼 이슈 해결

**에러 메시지**: `no matching manifest for linux/amd64 in the manifest list entries`

**원인**: 로컬 개발 환경(M1 Mac - ARM64)과 배포 환경(EC2 - AMD64)의 CPU 아키텍처 차이

**해결책**: `--platform linux/amd64` 플래그를 사용하여 타겟 플랫폼에 맞는 이미지 빌드

### 3.3 단일 컨테이너 실행

```bash
*# 1. ECR에서 이미지 다운로드*
docker pull 002177417362.dkr.ecr.ap-northeast-2.amazonaws.com/instagram-server

*# 2. 컨테이너 실행 (백그라운드, 포트 매핑)*
docker run -d -p 8080:8080 \
002177417362.dkr.ecr.ap-northeast-2.amazonaws.com/instagram-server

*# 3. 실행 상태 확인*
docker ps
docker logs <container-id>
```

## 4. Docker Compose를 활용한 멀티 서비스 배포

### 4.1 프로젝트 구조 준비

```bash
*# 배포용 디렉토리 생성*
mkdir instagram-server && cd instagram-server
```

### 4.2 compose.yml 파일 작성

```yaml
version: '3.8'

services:
  app-server:
    image: 002177417362.dkr.ecr.ap-northeast-2.amazonaws.com/instagram-server:latest
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DB_HOST=my-db
      - REDIS_HOST=my-cache-server
    depends_on:
      my-db:
        condition: service_healthy
      my-cache-server:
        condition: service_healthy
    restart: unless-stopped

  my-db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: 1q2w3e4r
      MYSQL_DATABASE: mydb
      MYSQL_USER: app_user
      MYSQL_PASSWORD: app_password
    volumes:
      - mysql-data:/var/lib/mysql
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
    restart: unless-stopped

  my-cache-server:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    restart: unless-stopped

volumes:
  mysql-data:
  redis-data:
```

### 4.3 Docker Compose 실행

```yaml
*# 1. 모든 서비스 시작 (백그라운드)*
docker compose up -d

*# 2. 로그 확인*
docker compose logs -f

*# 3. 서비스 상태 확인*
docker compose ps
```

## 5. 애플리케이션 업데이트 배포

### 5.1 코드 수정 예시

```yaml
@RestController
public class AppController {
    @GetMapping("/")
    public String home() {
        return "New, World!"; *// 기존: "Hello, World!"*
    }
}
```

### 5.2 업데이트 배포 과정

```yaml
*# 1. 로컬에서 새 버전 빌드 및 푸시*
./gradlew clean build
aws ecr get-login-password --region ap-northeast-2 | \
docker login --username AWS --password-stdin \
002177417362.dkr.ecr.ap-northeast-2.amazonaws.com

docker build --platform linux/amd64 -t instagram-server .
docker tag instagram-server:latest \
002177417362.dkr.ecr.ap-northeast-2.amazonaws.com/instagram-server:latest
docker push 002177417362.dkr.ecr.ap-northeast-2.amazonaws.com/instagram-server:latest

*# 2. EC2에서 업데이트된 이미지 배포*
docker compose pull app-server  *# 특정 서비스만 업데이트*
docker compose up -d --no-deps app-server  *# 의존성 없이 해당 서비스만 재시작*
```

## 6. Docker 실습 중 자주 발생하는 질문들

### Q1. 컨테이너가 계속 재시작되는 경우?

```bash
*# 컨테이너 로그 확인*
docker compose logs app-server

*# 컨테이너 내부 진입하여 디버깅*
docker compose exec app-server /bin/bash
```

### Q2. 데이터베이스 연결이 안 되는 경우?

```bash
*# 네트워크 연결 확인*
docker compose exec app-server ping my-db

*# 데이터베이스 접속 테스트*
docker compose exec my-db mysql -u root -p
```

### Q3. 이미지 빌드 시 메모리 부족?

```bash
*# 불필요한 이미지/컨테이너 정리*
docker system prune -a

*# 빌드 캐시 정리*
docker builder prune
```

### Q4. 볼륨 데이터 백업은?

```bash
*# MySQL 데이터 백업*
docker compose exec my-db mysqldump -u root -p mydb > backup.sql

*# 볼륨 전체 백업*
docker run --rm -v instagram-server_mysql-data:/data -v $(pwd):/backup alpine tar czf /backup/mysql-backup.tar.gz /data
```

## 7. 심화 운영 팁

### 7.1 로그 관리

```bash
*# 로그 로테이션 설정*
docker compose up -d --log-opt max-size=10m --log-opt max-file=3
```

### 7.2 리소스 제한

```bash
services:
  app-server:
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
```

### 7.3 환경별 설정 분리

bash

```bash
*# 개발환경*
docker compose -f compose.yml -f compose.dev.yml up

*# 운영환경*  
docker compose -f compose.yml -f compose.prod.yml up
```

이렇게 정리하면 Docker의 기본 개념부터 실제 운영까지의 전 과정을 체계적으로 학습할 수 있습니다.